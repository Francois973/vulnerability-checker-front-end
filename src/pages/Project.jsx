import { useState } from "react";
import { useEffect } from "react";
import { useLocation, useParams } from "react-router-dom";
import useProjectChannel from "../hook/useProjectChannel";

function Project() {
  const [project, setProject] = useState();
  const [ecosystems, setEcosystems] = useState({});
  const [vulnerabilities, setVulnerabilities] = useState([]);
  const [loading, setLoading] = useState(false);
  const { uuid } = useParams();

  useProjectChannel({
    uuid,
    setVulnerabilities,
    setEcosystems,
    setProject,
  });

  useEffect(() => {
    if (uuid && !project && !loading) {
      const fetchProject = async () => {
        const response = await fetch(
          `http://localhost:3000/api/v1/projects/${uuid}`
        );
        const project = await response.json();
        setProject(project);
        setVulnerabilities(project.vulnerabilities);
        setEcosystems(project.ecosystems);
      };

      fetchProject();
    }
  }, [uuid, project, loading]);

  console.log(vulnerabilities);
  if (!project) {
    return <p>Loading....</p>;
  }

  return (
    <div>
      <h2>{project.url}</h2>
      <p>Status: {project.status}</p>
      {Object.entries(ecosystems).map(([ecosystem, status]) => {
        return (
          <div key={ecosystem}>
            <h1>
              {ecosystem} - {status}
            </h1>
            <ul>
              {vulnerabilities
                .filter((v) => v.ecosystem === ecosystem)
                .map((v, i) => (
                  <li key={i}>
                    {v.stack}: {v.summary} ({v.github_version_ranges})
                    {v.severity}
                  </li>
                ))}
            </ul>
          </div>
        );
      })}
    </div>
  );
}

export default Project;
