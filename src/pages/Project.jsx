import { useState } from "react";
import { useEffect } from "react";
import { NavLink, useLocation, useParams } from "react-router-dom";
import useProjectChannel from "../hook/useProjectChannel";
import Logo from "../components/Logo";
import Banner from "../components/Banner";
import Loader from "../components/Loader";
import RedCircle from "../components/RedCircle";
import GreenCircle from "../components/GreenCircle";
import Modal from "../components/Modal";
import useModal from "../hook/useModal";

// Better way to reduce bundle size

function Project() {
  const [project, setProject] = useState();
  const [ecosystems, setEcosystems] = useState({});
  const [vulnerabilities, setVulnerabilities] = useState([]);
  const [loading, setLoading] = useState(false);
  const { uuid } = useParams();
  const { isShowing, toggle } = useModal();

  useProjectChannel({
    uuid,
    setVulnerabilities,
    setEcosystems,
    setProject,
  });

  useEffect(() => {
    if (uuid && !project && !loading) {
      const fetchProject = async () => {
        const response = await fetch(
          `http://localhost:3000/api/v1/projects/${uuid}`
        );
        const project = await response.json();
        setProject(project);
        setVulnerabilities(project.vulnerabilities);
        setEcosystems(project.ecosystems);
      };

      fetchProject();
    }
  }, [uuid, project, loading]);

  console.log(vulnerabilities);
  if (!project) {
    return <p>Loading....</p>;
  }

  return (
    <div className="min-h-screen">
      <Logo />
      <div className="flex flex-col gap-y-14 items-center">
        <Banner />
        <div className="pr-4 pl-4 pt-3 pb-3 bg-dark-color w-1/4 text-center rounded-md mb-11">
          {project.status === "completed" ? (
            <div className="flex flex-row justify-center gap-x-3">
              <p>Status</p>
              <svg
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 24 24"
                strokeWidth={1.5}
                stroke="currentColor"
                className="w-6 h-6"
              >
                <path
                  strokeLinecap="round"
                  strokeLinejoin="round"
                  d="M4.5 12.75l6 6 9-13.5"
                />
              </svg>
            </div>
          ) : (
            <p>Status: New</p>
          )}
        </div>
      </div>
      <div className="flex flex-col justify-left gap-y-4 ml-20 ">
        <NavLink
          to="/"
          className="bg-green-color p-2 w-24 text-center rounded-md hover:bg-green-900 transition ease-in-out delay-50"
        >
          Home
        </NavLink>
        <span className="text-2xl font-bold">
          There are {vulnerabilities.length} vulnerabilities
          <br /> in you repository
        </span>
      </div>
      {Object.entries(ecosystems).map(([ecosystem, status]) => {
        return (
          <div key={ecosystem}>
            <div className="flex flex-row">
              {status === "pending" ? (
                <ul className="pr-5 pl-5 pt-2 pb-2 bg-dark-color w-80 m-auto mb-4 flex flex-row justify-around rounded-md">
                  <li>
                    {ecosystem} - {status}
                  </li>
                  <Loader />
                </ul>
              ) : null}
              {status === "scanning" ? (
                <ul className="pr-5 pl-5 pt-2 pb-2 bg-dark-color w-80 m-auto mb-4 flex flex-row justify-around rounded-md">
                  <li>
                    {ecosystem} - {status}
                  </li>
                  <Loader />
                </ul>
              ) : null}
              {status === "unavailable" ? (
                <ul className="pr-5 pl-5 pt-2 pb-2 bg-dark-color w-80 m-auto mb-4 flex flex-row gap-x-5 rounded-md items-center border-2 border-white">
                  <li>
                    {ecosystem} - {status}
                  </li>
                  <RedCircle />
                </ul>
              ) : null}
              {status === "completed" ? (
                <ul className="pr-5 pl-5 pt-2 pb-2 bg-dark-color w-80 m-auto mb-4 flex flex-row gap-x-5 rounded-md items-center border-2 border-white">
                  <li>
                    {ecosystem} - {status}
                  </li>
                  <GreenCircle />
                </ul>
              ) : null}
            </div>
            <div className="w-1/2 m-auto">
              <ul>
                {vulnerabilities
                  .filter((v) => v.ecosystem === ecosystem)
                  .map((v, i) => (
                    <li
                      key={i}
                      className="p-3 bg-dark-color mb-5 rounded-md min-h-9 flex flex-col gap-y-2 "
                    >
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        fill="none"
                        viewBox="0 0 24 24"
                        strokeWidth={1.5}
                        stroke="currentColor"
                        className="w-6 h-6"
                      >
                        <path
                          strokeLinecap="round"
                          strokeLinejoin="round"
                          d="M12.75 19.5v-.75a7.5 7.5 0 00-7.5-7.5H4.5m0-6.75h.75c7.87 0 14.25 6.38 14.25 14.25v.75M6 18.75a.75.75 0 11-1.5 0 .75.75 0 011.5 0z"
                        />
                      </svg>
                      <strong>{v.stack}</strong> {v.summary} (
                      {v.github_version_ranges}) {v.severity}
                      <span>{v.ghsaId}</span>
                      <button
                        className="bg-white text-white active:bg-pink-600 font-bold uppercase text-sm px-6 py-3 rounded shadow hover:shadow-lg outline-none focus:outline-none mr-1 mb-1 ease-linear transition-all duration-150"
                        type="button"
                        onClick={toggle}
                      ></button>
                      <Modal
                        isShowing={isShowing}
                        hide={toggle}
                        vulnerabilities={v.details}
                      />
                    </li>
                  ))}
              </ul>
            </div>
          </div>
        );
      })}
    </div>
  );
}

export default Project;
