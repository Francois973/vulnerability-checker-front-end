import React from "react";
import { useState, useEffect } from "react";
import { useParams } from "react-router-dom";
import LanguagesRepos from "../components/LanguagesRepos";
import LoaderUsername from "../components/LoaderUsername";
import { apiBaseUrl } from "../utils/config";

const Repositories = () => {
  const { username } = useParams();
  const [error, setError] = useState(null);
  const [isLoading, setIsLoading] = useState(false);
  const [repositories, setRepositories] = useState({});

  useEffect(() => {
    if (username) {
      setIsLoading(true);
      const fetchRepositories = async () => {
        try {
          const response = await fetch(
            `${apiBaseUrl}/repositories/${username}`
          );
          const result = await response.json();

          setRepositories(result);
          setIsLoading(false);

          if (!response.ok) {
            throw new Error("An error has been found");
          }
        } catch (error) {
          setError(error.message);
          setIsLoading(false);
        }
      };
      fetchRepositories();
    }
  }, [username]);

  return (
    <div className="relative">
      {isLoading
        ? null
        : error && <div className="text-lg m-auto text-[#FF0000]">{error}</div>}
      <div className="h-[20px] absolute left-20 top-[-54.2px] w-8 mt-[20px]">
        {isLoading ? <LoaderUsername /> : null}
      </div>
      <div className="flex flex-wrap gap-[4%] gap-y-10 h-auto mt-10 w-full space-between">
        {repositories["repositories"] &&
          Object.entries(repositories["repositories"]).map(([key, value]) => (
            <div
              key={key}
              className="p-6 bg-dark-color w-[48%] rounded-md h-auto flex flex-col items-start justify-between"
            >
              <img
                src="https://www.logo.wine/a/logo/GitHub/GitHub-Icon-White-Dark-Background-Logo.wine.svg"
                className="h-6 w-6"
              />
              <a
                className="text-sky-400 text-[24px] hover:opacity-[0.4] transition ease-in-out delay-50"
                href={value.url}
                target="_blank"
              >
                {value.name}
              </a>
              <li className="hidden md:contents grow">{value.url}</li>
              <LanguagesRepos languages={value.languages} url={value.url} />
            </div>
          ))}
      </div>
    </div>
  );
};

export default Repositories;
